<?php

/**
 * ProfileTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class ProfileTable extends Doctrine_Table {

  /**
   * Returns an instance of this class.
   *
   * @return object ProfileTable
   */
  public static function getInstance() {
    return Doctrine_Core::getTable('Profile');
  }

  public function findByFields($exp, $excludedIds = array(), $limit = 100) {
    if ($exp == "%") {
      return $users = $this->createQuery('u')
          ->whereNotIn("u.id", $excludedIds)
          ->orderby("u.first_name, u.last_name ASC")
          ->limit($limit)
          ->execute();
    } else {
      return $this->createQuery('u')
              ->where("(u.first_name LIKE '%{$exp}%' OR u.last_name LIKE '%{$exp}%' OR u.email LIKE '%{$exp}%')")
              ->whereNotIn("u.id", $excludedIds)
              ->orderby("u.first_name, u.last_name ASC")
              ->limit($limit)
              ->execute();
    }
  }

  public function findBySearch($exp, $previousEmailAddresses = array(), $limit = 100) {
    return $this->createQuery('u')
            ->where("(u.first_name LIKE '%{$exp}%' OR u.last_name LIKE '%{$exp}%' OR u.email LIKE '%{$exp}%')")
            ->whereNotIn("u.email", $previousEmailAddresses)
            ->orderby("u.first_name, u.last_name ASC")
            ->limit($limit)
            ->execute();
  }

  public function retrieveByIds($ids = array()) {
    if (count($ids) == 0) {
      return array();
    }
    $query = $this->createQuery('u')
        ->whereIn('u.id', $ids);

    return $query->execute();
  }

  public function retrieveProfileIdsByDiscussionId($discussionId = null, $isRemoved = 0) {
    $query = $this->createQuery('u')
        ->select('u.id')
        ->innerJoin('u.DiscussionPeer dm')
        ->where('dm.discussion_id = ?', $discussionId)
        ->addWhere('dm.is_removed = ?', $isRemoved);

    return $query->execute()->getPrimaryKeys();
  }

  public function retrieveByEmails($emails = "") {
    $emails = explode(";", $emails);
    if (count($emails) == 0) {
      return array();
    }
    $query = $this->createQuery('u')
        ->whereIn('u.email', $emails);

    return $query->execute();
  }

  /**
   * Retrieves a Profile object by username and is_active flag.
   *
   * @param  string  $username The username
   * @param  boolean $isActive The user's status
   *
   * @return Profile
   */
  public function retrieveByUsername($username, $isActive = true) {
    $query = Doctrine_Core::getTable('Profile')->createQuery('u')
        ->where('u.username = ?', $username)
        ->addWhere('u.is_active = ?', $isActive);

    return $query->fetchOne();
  }

  /**
   * Retrieves a Profile object by username or email and is_active flag.
   *
   * @param  string  $username The username
   * @param  boolean $isActive The user's status
   *
   * @return Profile
   */
  public function retrieveByUsernameOrEmailAddress($username, $isActive = true) {
    $query = Doctrine_Core::getTable('Profile')->createQuery('u')
        ->where('u.username = ? OR u.email = ?', array($username, $username))
        ->addWhere('u.is_active = ?', $isActive);

    return $query->fetchOne();
  }

}